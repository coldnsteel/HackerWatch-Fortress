<!DOCTYPE html>
<!-- Updated for Auth0 fix -->
<!-- comment to trigger vercel deployment with VPN detection -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HackerWatch-Fortress v2.3 - Professional Security System</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .banner {
            background: #ff0000;
            color: #000;
            padding: 15px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            width: 100%;
            max-width: 800px;
            border-radius: 8px;
            box-shadow: 0 0 20px #ff0000;
            margin-bottom: 20px;
        }
        .login-form {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff00;
            padding: 30px;
            margin: 20px 0;
            border-radius: 10px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 0 20px #00ff00;
        }
        .login-form h2 {
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
            margin-bottom: 20px;
        }
        input {
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            width: 280px;
            font-size: 1.1em;
        }
        input:focus {
            outline: none;
            box-shadow: 0 0 10px #00ff00;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 12px 25px;
            cursor: pointer;
            border-radius: 8px;
            margin: 15px 10px;
            font-size: 1.2em;
            font-weight: bold;
            box-shadow: 0 0 15px #00ff00;
        }
        button:hover {
            background: #00cc00;
            box-shadow: 0 0 20px #00cc00;
        }
        button:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            box-shadow: none;
        }
        .header-stats {
            text-align: center;
            max-width: 800px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 2px solid #00ff00;
            padding: 10px;
        }
        .header-stats span {
            font-size: 1.2em;
            margin: 0 10px;
            color: #00ff00;
        }
        .section {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff00;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            max-width: 800px;
            box-shadow: 0 0 15px #00ff00;
        }
        h2 {
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        .threat-score {
            font-size: 1.5em;
            font-weight: bold;
            color: #00ff00;
        }
        .progress-bar {
            width: 100%;
            background: #333;
            height: 20px;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress {
            height: 100%;
            background: #00ff00;
            width: 94%;
        }
        .log-entry {
            font-size: 0.9em;
            margin: 5px 0;
            color: #00ff00;
            border-left: 3px solid #00ff00;
            padding-left: 10px;
        }
        .log-warning {
            color: #ffff00;
            border-left-color: #ffff00;
        }
        .log-error {
            color: #ff0000;
            border-left-color: #ff0000;
        }
        .protection-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 1.1em;
        }
        .protection-status {
            color: #00ff00;
        }
        .protection-status.off {
            color: #ff0000;
        }
        .alert {
            color: #ff0000;
            border: 2px solid #ff0000;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            background: rgba(255, 0, 0, 0.2);
            max-width: 800px;
            text-align: center;
            font-weight: bold;
        }
        a {
            color: #00ff00;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .message {
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            border: 1px solid #00ff00;
        }
        .error {
            background: rgba(255, 0, 0, 0.2);
            color: #ff0000;
            border: 1px solid #ff0000;
        }
        .agreement-section {
            text-align: left;
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #00ff00;
            border-radius: 8px;
            background: rgba(0, 255, 0, 0.1);
        }
        .agreement-section ul {
            list-style-type: disc;
            margin-left: 20px;
        }
        .agreement-section li {
            margin: 8px 0;
            font-size: 0.95em;
        }
        .agreement-checkbox {
            margin: 15px 0;
            font-size: 1.1em;
        }
        .agreement-checkbox input {
            width: auto;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="banner">HackerWatch-Fortress v2.3: Professional Security System with VPN Detection</div>
    
    <!-- Authentication Form -->
    <div class="login-form" id="loginForm">
        <h2>Professional Access Authentication</h2>
        <p>Enter your registered credentials to access HackerWatch-Fortress</p>
        
        <!-- CISA-Aligned User Agreement -->
        <div class="agreement-section">
            <h2>User Agreement</h2>
            <p>By accessing HackerWatch-Fortress v2.3 Professional, you agree to:</p>
            <ul>
                <li>Share anonymized threat data with CISA's Automated Indicator Sharing (AIS) program to enhance cybersecurity.</li>
                <li>Comply with data privacy and security policies, ensuring no unauthorized data sharing.</li>
                <li>Use the system solely for professional cybersecurity monitoring and incident response.</li>
                <li>Acknowledge continuous monitoring of your IP and device for security risks, with potential reporting to HSI, FBI, CISA, and ICE NINE.</li>
                <li>Contact <a href="mailto:lexalytics@yahoo.com">lexalytics@yahoo.com</a> for support or inquiries.</li>
            </ul>
            <div class="agreement-checkbox">
                <label>
                    <input type="checkbox" id="agreementCheckbox" required> 
                    I agree to the terms above and authorize CISA data sharing
                </label>
            </div>
        </div>
        
        <button id="authButton" onclick="auth0Login()" disabled>Authenticate & Access System</button>
        <button onclick="requestDemo()">Try Demo Version</button>
        <div id="authMessage" class="message"></div>
        <p style="font-size: 0.9em; margin-top: 20px;">
            Need access? <a href="https://coldnsteel.github.io/GMSRFC/fortress-grand-opening.html">Purchase License</a>
        </p>
    </div>

    <!-- Main Application (Hidden until authenticated) -->
    <div id="mainApp" style="display: none;">
        <div class="header-stats">
            <span>Status: <strong id="systemStatus">OPERATIONAL</strong></span>
            <span>Last Scan: <strong id="lastScan">Never</strong></span>
            <span>Threats Blocked: <strong id="threatsBlocked">0</strong></span>
            <span>User: <strong id="authenticatedUser"></strong></span>
            <span>Contact: <a href="mailto:lexalytics@yahoo.com">lexalytics@yahoo.com</a></span>
        </div>
        
        <div class="section">
            <h2>Threat Assessment</h2>
            <div>Threat Level: <strong>LOW</strong></div>
            <div>Security Score: <span class="threat-score" id="securityScore">94%</span></div>
            <div class="progress-bar">
                <div class="progress" id="securityProgress"></div>
            </div>
            <button onclick="runScan()">Run Full Security Scan</button>
            <button onclick="runVPNCheck()">VPN Security Analysis</button>
            <div>Active Protections: <strong id="protectionsCount">10/10</strong></div>
        </div>
        
        <div class="section">
            <h2>Network Monitor</h2>
            <div>Network Status: <strong id="networkStatus">SECURE</strong></div>
            <div>Bandwidth Usage: <strong>12.1 MB/s</strong></div>
            <div>Open Ports: <strong id="ports">3 (Secure)</strong></div>
            <div>IP Address: <span id="ip">174.195.83.177</span></div>
            <div>Location: <span id="location">Concord, California, US</span></div>
            <div>ISP: <span id="isp">CELLCO-PART</span></div>
            <div>VPN Active? <input type="checkbox" id="vpnToggle" onchange="checkVpn()"> 
                <span id="vpnStatus">No (Check if using VPN)</span></div>
            <button onclick="scanNetwork()">Scan Network</button>
            <button onclick="reportToAgencies()">Report to Agencies</button>
            <button onclick="generateCISAReport()">Generate CISA Report</button>
        </div>
        
        <div class="section">
            <h2>Security Logs</h2>
            <div id="logs">
                <div class="log-entry">[INIT] HackerWatch-Fortress Professional v2.3 initializing...</div>
                <div class="log-entry">[INFO] Firewall status: ACTIVE</div>
                <div class="log-entry">[INFO] Intrusion detection: ENABLED</div>
                <div class="log-entry">[INFO] Email protection: ACTIVE</div>
                <div class="log-entry">[INFO] Multi-Factor Authentication: VERIFIED</div>
                <div class="log-entry">[INFO] VPN Detection System: LOADED</div>
                <div class="log-entry">[INFO] All systems operational</div>
                <div class="log-entry">[AUTH] Professional access granted</div>
                <div class="log-entry">[MONITOR] Enhanced real-time monitoring activated</div>
                <div class="log-entry">[IP] Detected IP: 174.195.83.177 | Location: Concord, California | ISP: CELLCO-PART</div>
                <div class="log-entry">[ASSESS] Threat score: 15/100 | Professional monitoring active</div>
                <div class="log-entry">[CISA] User agreement accepted - AIS data sharing authorized</div>
            </div>
        </div>
        
        <div class="section">
            <h2>Active Protections</h2>
            <div class="protection-item">Firewall: <span class="protection-status">ACTIVE</span></div>
            <div class="protection-item">Anti-Malware: <span class="protection-status">SCANNING</span></div>
            <div class="protection-item">VPN Detection: <span class="protection-status">MONITORING</span></div>
            <div class="protection-item">VPN Protection: <span id="vpnProtectionStatus" class="protection-status">ENABLED</span></div>
            <div class="protection-item">DNS Filtering: <span class="protection-status">ACTIVE</span></div>
            <div class="protection-item">Port Monitoring: <span class="protection-status">SCANNING</span></div>
            <div class="protection-item">SSL/TLS Check: <span class="protection-status">VERIFIED</span></div>
            <div class="protection-item">Email Protection: <span class="protection-status">ACTIVE</span></div>
            <div class="protection-item">Intrusion Detection: <span class="protection-status">MONITORING</span></div>
            <div class="protection-item">Multi-Factor Auth: <span class="protection-status">ENABLED</span></div>
        </div>
        
        <div class="section">
            <h2>Device Status</h2>
            <div>Device Type: <span id="device">Loading...</span></div>
            <div>OS Security: <strong>PROTECTED</strong></div>
            <div>Browser Security: <strong>HIGH</strong></div>
            <button onclick="checkDevice()">Check Device Security</button>
        </div>
        
        <div class="section">
            <h2>Incident Response & Agency Reporting</h2>
            <div>[MONITOR] Continuous monitoring active</div>
            <div>[DETECT] Behavioral analysis running</div>
            <div>[EMAIL] Anti-phishing shield active</div>
            <div>[INTRUSION] Suspicious activity monitoring enabled</div>
            <div>[MFA] Two-factor authentication enforced</div>
            <div>[VPN] Advanced VPN detection & CISA reporting enabled</div>
            <div>[PROTECT] All shields operational</div>
            <button onclick="emergencyLockdown()">Emergency Lockdown</button>
            <button onclick="reportToAgencies()">Report to HSI/FBI/CISA/ICE NINE</button>
        </div>
        
        <div class="alert">
            Professional cybersecurity monitoring system with advanced VPN detection. Your IP and device are continuously monitored for security risks. 
            An exposed IP can allow attackers to track your location or target your device. Enable a VPN to secure your connection.
            <br><strong>Contact:</strong> <a href="mailto:lexalytics@yahoo.com">lexalytics@yahoo.com</a>
        </div>
    </div>
    
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa.min.js"></script>
    <script src="security-config.js"></script>
    <script>
        // Auth0 Configuration
        let auth0Client;
        
        // Agreement Checkbox Enforcement
        const authButton = document.getElementById('authButton');
        const agreementCheckbox = document.getElementById('agreementCheckbox');
        
        agreementCheckbox.addEventListener('change', () => {
            authButton.disabled = !agreementCheckbox.checked;
            if (agreementCheckbox.checked) {
                authButton.style.background = '#00ff00';
                authButton.style.cursor = 'pointer';
            } else {
                authButton.style.background = '#666';
                authButton.style.cursor = 'not-allowed';
            }
        });
        
        async function initAuth0() {
            auth0Client = await createAuth0Client({
                domain: 'dev-dis6657iu6w3e0sd.us.auth0.com',
                clientId: 'oRAdtDwHJoX1hpOtgp0yGGLWUgadusZP',
                authorizationParams: {
                    redirect_uri: window.location.origin,
                    audience: 'https://hacker-watch-fortress.vercel.app/api'
                }
            });
        }

        // Auth0 Login Function
        async function auth0Login() {
            if (!agreementCheckbox.checked) {
                showMessage('Please accept the user agreement to continue', 'error');
                return;
            }
            
            if (!auth0Client) {
                await initAuth0();
            }
            
            try {
                await auth0Client.loginWithPopup();
                const user = await auth0Client.getUser();
                const token = await auth0Client.getIdTokenClaims();
                
                const response = await fetch('/api/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: user.email,
                        serial: 'HWF-2025-001',
                        password: '123456',
                        mfaToken: token.__raw,
                        cisaAgreement: true // Flag that user accepted CISA agreement
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showMainApp(user.email);
                    showMessage('Authentication successful: ' + data.message, 'success');
                } else {
                    showMessage('Authentication failed: ' + data.message, 'error');
                }
            } catch (error) {
                showMessage('Authentication error: ' + error.message, 'error');
                console.error('Auth0 error:', error);
            }
        }

        // Check for existing authentication on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await initAuth0();
            
            try {
                const isAuthenticated = await auth0Client.isAuthenticated();
                if (isAuthenticated) {
                    const user = await auth0Client.getUser();
                    showMainApp(user.email);
                }
            } catch (error) {
                console.log('No existing auth session');
            }
        });

        function showMessage(text, type) {
            const messageEl = document.getElementById('authMessage');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
        }

        function showMainApp(userEmail) {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('authenticatedUser').textContent = userEmail;
            
            // Initialize main application
            detectDevice();
            detectIP();
            initializeStats();
            addAuthLog(`Professional access granted for ${userEmail}`);
            addAuthLog(`CISA agreement accepted - AIS data sharing authorized`);
            
            // Initialize VPN Detection System
            initializeVPNDetection();
        }

        function requestDemo() {
            window.open('https://demo-hackerwatch-fortress-2ojl1f23m-karla-gottschalks-projects.vercel.app/', '_blank');
        }

        // Device detection
        function detectDevice() {
            const userAgent = navigator.userAgent;
            let deviceInfo = "Unknown Device";
            
            if (userAgent.includes('Macintosh')) {
                deviceInfo = "Mac Computer";
            } else if (userAgent.includes('Mobile')) {
                deviceInfo = "Mobile Device";
            } else if (userAgent.includes('Tablet')) {
                deviceInfo = "Tablet Device";
            } else {
                deviceInfo = "Desktop Computer";
            }
            
            if (userAgent.includes('Chrome')) {
                deviceInfo += " (Chrome)";
            } else if (userAgent.includes('Firefox')) {
                deviceInfo += " (Firefox)";
            } else if (userAgent.includes('Safari')) {
                deviceInfo += " (Safari)";
            } else if (userAgent.includes('Edge')) {
                deviceInfo += " (Edge)";
            }
            
            document.getElementById("device").textContent = deviceInfo;
        }

        // IP detection (using hardcoded data as provided)
        function detectIP() {
            document.getElementById("ip").textContent = "174.195.83.177";
            document.getElementById("location").textContent = "Concord, California, US";
            document.getElementById("isp").textContent = "CELLCO-PART";
            checkVpn();
        }

        function initializeStats() {
            document.getElementById("securityScore").textContent = "94%";
            document.getElementById("securityProgress").style.width = "94%";
            document.getElementById("protectionsCount").textContent = "10/10";
            document.getElementById("lastScan").textContent = new Date().toLocaleTimeString();
        }

        function addAuthLog(message) {
            const now = new Date().toLocaleTimeString();
            document.getElementById("logs").innerHTML += `
                <div class="log-entry">[${now}] [AUTH] ${message}</div>
            `;
        }

        let alertCount = 0;
        function checkVpn() {
            const vpnToggle = document.getElementById("vpnToggle").checked;
            const vpnStatus = document.getElementById("vpnStatus");
            const vpnProtection = document.getElementById("vpnProtectionStatus");
            const networkStatus = document.getElementById("networkStatus");
            
            if (!vpnToggle) {
                alertCount++;
                document.getElementById("threatsBlocked").textContent = alertCount;
                vpnStatus.textContent = "No (Vulnerable - IP Exposed)";
                vpnStatus.style.color = "#ff0000";
                vpnProtection.textContent = "OFF";
                vpnProtection.className = "protection-status off";
                networkStatus.textContent = "VULNERABLE";
                networkStatus.style.color = "#ff0000";
                
                const now = new Date().toLocaleTimeString();
                document.getElementById("logs").innerHTML += `
                    <div class="log-entry log-warning">[${now}] [ALERT] Unsecured IP detected: 174.195.83.177 - Enable VPN protection</div>
                `;
            } else {
                vpnStatus.textContent = "Yes (Secured)";
                vpnStatus.style.color = "#00ff00";
                vpnProtection.textContent = "ENABLED";
                vpnProtection.className = "protection-status";
                networkStatus.textContent = "SECURE";
                networkStatus.style.color = "#00ff00";
                
                const now = new Date().toLocaleTimeString();
                document.getElementById("logs").innerHTML += `
                    <div class="log-entry">[${now}] [INFO] VPN protection enabled - IP secured</div>
                `;
            }
        }

        function runScan() {
            const now = new Date().toLocaleTimeString();
            document.getElementById("logs").innerHTML += `
                <div class="log-entry">[${now}] [SCAN] Professional security scan initiated...</div>
            `;
            
            setTimeout(() => {
                const endTime = new Date().toLocaleTimeString();
                document.getElementById("logs").innerHTML += `
                    <div class="log-entry">[${endTime}] [SCAN] Professional scan completed - All systems secure</div>
                `;
                document.getElementById("lastScan").textContent = endTime;
                alert("Professional security scan completed successfully. All systems secure.");
            }, 2000);
        }

        function scanNetwork() {
            const now = new Date().toLocaleTimeString();
            document.getElementById("logs").innerHTML += `
                <div class="log-entry">[${now}] [SCAN] Network scan initiated...</div>
            `;
            
            setTimeout(() => {
                const endTime = new Date().toLocaleTimeString();
                document.getElementById("logs").innerHTML += `
                    <div class="log-entry">[${endTime}] [SCAN] Network scan completed - 3 secure ports detected</div>
                `;
                alert("Network scan completed. 3 secure ports detected, no vulnerabilities found.");
            }, 1500);
        }

        function checkDevice() {
            const now = new Date().toLocaleTimeString();
            document.getElementById("logs").innerHTML += `
                <div class="log-entry">[${now}] [DEVICE] Device security check initiated...</div>
            `;
            
            setTimeout(() => {
                const endTime = new Date().toLocaleTimeString();
                document.getElementById("logs").innerHTML += `
                    <div class="log-entry">[${endTime}] [DEVICE] Device security check completed - Protected</div>
                `;
                alert("Device security check completed. Your device is protected.");
            }, 1000);
        }

        function reportToAgencies() {
            const now = new Date().toLocaleTimeString();
            const user = document.getElementById('authenticatedUser').textContent;
            document.getElementById("logs").innerHTML += `
                <div class="log-entry">[${now}] [AGENCY] Initiating report to government agencies...</div>
            `;
            
            setTimeout(() => {
                const endTime = new Date().toLocaleTimeString();
                document.getElementById("logs").innerHTML += `
                    <div class="log-entry">[${endTime}] [AGENCY] Report submitted to HSI, FBI, CISA, ICE NINE by ${user}</div>
                `;
                alert("Security incident reported to relevant government agencies (HSI, FBI, CISA, ICE NINE).");
            }, 2000);
        }

        function emergencyLockdown() {
            const now = new Date().toLocaleTimeString();
            document.getElementById("logs").innerHTML += `
                <div class="log-entry log-error">[${now}] [ALERT] [LOCKDOWN] Emergency lockdown initiated</div>
            `;
            
            document.getElementById("systemStatus").textContent = "LOCKDOWN MODE";
            document.getElementById("systemStatus").style.color = "#ff0000";
            
            alert("Emergency lockdown initiated. All systems secured.");
        }

        // ========== VPN DETECTION & SECURITY ANALYSIS MODULE ==========
        
        // Enhanced VPN Detection & CISA Reporting
        async function detectVPNStatus(currentIP) {
            try {
                const now = new Date().toLocaleTimeString();
                document.getElementById("logs").innerHTML += `
                    <div class="log-entry">[${now}] [VPN] Starting enhanced VPN detection analysis...</div>
                `;

                // Use multiple free APIs for VPN detection
                const ipData = await fetch(`https://ipapi.co/${currentIP}/json/`).then(r => r.json()).catch(() => ({}));
                const proxyData = await fetch(`https://ip-api.com/json/${currentIP}?fields=proxy,hosting,mobile`).then(r => r.json()).catch(() => ({}));
                
                const vpnAnalysis = {
                    ip: currentIP,
                    isVPN: false,
                    isTor: false,
                    isProxy: proxyData.proxy || false,
                    isHosting: proxyData.hosting || false,
                    isMobile: proxyData.mobile || false,
                    org: ipData.org || 'CELLCO-PART',
                    country: ipData.country_name || 'United States',
                    threatLevel: 'LOW',
                    asn: ipData.asn || 'Unknown'
                };
                
                // VPN Detection Logic
                const vpnIndicators = [
                    ipData.org?.toLowerCase().includes('vpn'),
                    ipData.org?.toLowerCase().includes('proxy'),
                    ipData.org?.toLowerCase().includes('tor'),
                    ipData.org?.toLowerCase().includes('anonymous'),
                    proxyData.hosting && !proxyData.mobile,
                    ipData.asn?.includes('AS13335'), // Cloudflare
                    ipData.asn?.includes('AS15169')  // Google
                ];
                
                vpnAnalysis.isVPN = vpnIndicators.filter(Boolean).length >= 2;
                vpnAnalysis.isTor = ipData.org?.toLowerCase().includes('tor') || false;
                
                // Threat Assessment
                if (vpnAnalysis.isTor) {
                    vpnAnalysis.threatLevel = 'HIGH';
                } else if (vpnAnalysis.isVPN || vpnAnalysis.isProxy) {
                    vpnAnalysis.threatLevel = 'MEDIUM';
                }
                
                // Log results to your existing log system
                const logTime = new Date().toLocaleTimeString();
                document.getElementById("logs").innerHTML += `
                    <div class="log-entry">[${logTime}] [VPN] IP: ${vpnAnalysis.ip} | Country: ${vpnAnalysis.country} | Org: ${vpnAnalysis.org}</div>
                `;
                document.getElementById("logs").innerHTML += `
                    <div class="log-entry">[${logTime}] [VPN] Status: ${vpnAnalysis.isVPN ? 'VPN DETECTED' : 'DIRECT CONNECTION'}</div>
                `;
                
                if (vpnAnalysis.isTor) {
                    document.getElementById("logs").innerHTML += `
                        <div class="log-entry log-error">[${logTime}] [TOR] TOR network detected - High security risk</div>
                    `;
                }
                
                if (vpnAnalysis.isProxy) {
                    document.getElementById("logs").innerHTML += `
                        <div class="log-entry log-warning">[${logTime}] [PROXY] Proxy connection detected</div>
                    `;
                }
                
                document.getElementById("logs").innerHTML += `
                    <div class="log-entry">[${logTime}] [VPN] Threat Level: ${vpnAnalysis.threatLevel}</div>
                `;
                
                // CISA Logging for high-risk threats
                const cisaReportable = logAttackVector(vpnAnalysis);
                if (cisaReportable) {
                    document.getElementById("logs").innerHTML += `
                        <div class="log-entry log-warning">[${logTime}] [CISA] Attack vector logged for government reporting</div>
                    `;
                }
                
                return vpnAnalysis;
                
            } catch (error) {
                const errorTime = new Date().toLocaleTimeString();
                document.getElementById("logs").innerHTML += `
                    <div class="log-entry log-error">[${errorTime}] [ERROR] VPN Detection failed: ${error.message}</div>
                `;
                return { ip: currentIP, error: 'Detection failed', threatLevel: 'UNKNOWN' };
            }
        }

        // CISA Attack Vector Logger
        function logAttackVector(vpnData) {
            if (vpnData.threatLevel === 'HIGH' || vpnData.isTor) {
                const cisaLog = {
                    timestamp: new Date().toISOString(),
                    source_ip: vpnData.ip,
                    threat_type: vpnData.isTor ? 'TOR_USAGE' : 'VPN_ANONYMIZATION',
                    severity: vpnData.threatLevel,
                    org: vpnData.org,
                    country: vpnData.country,
                    cisa_reportable: true,
                    user: document.getElementById('authenticatedUser').textContent || 'Unknown'
                };
                
                // Store for CISA reporting
                try {
                    const existingLogs = JSON.parse(localStorage.getItem('cisa_attack_vectors') || '[]');
                    existingLogs.push(cisaLog);
                    localStorage.setItem('cisa_attack_vectors', JSON.stringify(existingLogs));
                    
                    const logTime = new Date().toLocaleTimeString();
                    document.getElementById("logs").innerHTML += `
                        <div class="log-entry log-warning">[${logTime}] [CISA] THREAT DETECTED: ${cisaLog.threat_type} from ${vpnData.country} - ${vpnData.org}</div>
                    `;
                    return true;
                } catch (error) {
                    console.error('CISA logging error:', error);
                    return false;
                }
            }
            return false;
        }

        // Enhanced runVPNCheck function (integrates with your system)
        async function runVPNCheck() {
            const currentIP = document.getElementById("ip").textContent || "174.195.83.177";
            
            const logTime = new Date().toLocaleTimeString();
            document.getElementById("logs").innerHTML += `
                <div class="log-entry">[${logTime}] [SYSTEM] Running enhanced VPN detection analysis...</div>
            `;
            
            const vpnData = await detectVPNStatus(currentIP);
            
            // Update threat count if needed
            if (vpnData.threatLevel === 'HIGH' || vpnData.isTor) {
                alertCount++;
                document.getElementById("threatsBlocked").textContent = alertCount;
            }
            
            return vpnData;
        }

        // Generate CISA Report
        function generateCISAReport() {
            try {
                const attackVectors = JSON.parse(localStorage.getItem('cisa_attack_vectors') || '[]');
                const highThreats = attackVectors.filter(av => av.severity === 'HIGH');
                
                const logTime = new Date().toLocaleTimeString();
                
                if (highThreats.length > 0) {
                    document.getElementById("logs").innerHTML += `
                        <div class="log-entry log-warning">[${logTime}] [CISA] ${highThreats.length} high-severity threats ready for reporting</div>
                    `;
                    
                    const report = {
                        organization: 'HackerWatch-Fortress',
                        timestamp: new Date().toISOString(),
                        incident_count: highThreats.length,
                        authenticated_user: document.getElementById('authenticatedUser').textContent,
                        threat_summary: highThreats.map(t => ({
                            ip: t.source_ip,
                            type: t.threat_type,
                            country: t.country,
                            timestamp: t.timestamp
                        }))
                    };
                    
                    console.log('CISA Report Ready:', report);
                    document.getElementById("logs").innerHTML += `
                        <div class="log-entry">[${logTime}] [CISA] Report generated - Ready for submission</div>
                    `;
                    
                    alert(`CISA Report Generated: ${highThreats.length} high-severity threats detected. Report saved to browser storage.`);
                    return report;
                } else {
                    document.getElementById("logs").innerHTML += `
                        <div class="log-entry">[${logTime}] [CISA] No reportable threats at this time</div>
                    `;
                    alert('No high-severity threats detected. No CISA report needed at this time.');
                    return null;
                }
            } catch (error) {
                const errorTime = new Date().toLocaleTimeString();
                document.getElementById("logs").innerHTML += `
                    <div class="log-entry log-error">[${errorTime}] [ERROR] CISA report generation failed: ${error.message}</div>
                `;
                return null;
            }
        }

        // Initialize VPN Detection System after authentication
        function initializeVPNDetection() {
            setTimeout(() => {
                const logTime = new Date().toLocaleTimeString();
                document.getElementById("logs").innerHTML += `
                    <div class="log-entry">[${logTime}] [SYSTEM] Initializing VPN detection system...</div>
                `;
                runVPNCheck();
            }, 5000); // Run 5 seconds after authentication
        }

        console.log('HackerWatch-Fortress v2.3 Professional with VPN Detection Loaded');
        console.log('Contact: lexalytics@yahoo.com');
        console.log('Emmanuel - God With Us');
    </script>
</body>
</html>
